import { TLRU } from './utils/tlru.js';
import PQueue from 'p-queue';
import HTTP from 'ipfs-utils/src/http.js';
const cache = new TLRU(1000);
const ttl = 60 * 1000;
const Queue = PQueue.default ? PQueue.default : PQueue;
const httpQueue = new Queue({ concurrency: 4 });
const ipfsPath = response => {
  if (response.Path)
    return response.Path;
  throw new Error(response.Message);
};
export async function resolveDnslink(fqdn, opts) {
  const resolve = async (fqdn, opts = {}) => {
    const searchParams = new URLSearchParams(opts);
    searchParams.set('arg', fqdn);
    const query = searchParams.toString();
    if (!opts.nocache && cache.has(query)) {
      const response = cache.get(query);
      return ipfsPath(response);
    }
    const response = await httpQueue.add(async () => {
      const res = await HTTP.get('https://ipfs.io/api/v0/dns', { searchParams });
      const query = new URL(res.url).search.slice(1);
      const json = await res.json();
      cache.set(query, json, ttl);
      return json;
    });
    return ipfsPath(response);
  };
  return resolve(fqdn, opts);
}