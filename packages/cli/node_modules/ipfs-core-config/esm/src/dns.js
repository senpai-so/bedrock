import dns from 'dns';
import isIPFS from 'is-ipfs';
import errcode from 'err-code';
import { promisify } from 'util';
const MAX_RECURSIVE_DEPTH = 32;
export function resolveDnslink(domain, opts) {
  const nonRecursive = !opts.recursive;
  let depth = MAX_RECURSIVE_DEPTH;
  if (nonRecursive) {
    depth = undefined;
  }
  return recursiveResolveDnslink(domain, depth);
}
async function recursiveResolveDnslink(domain, depth) {
  if (depth === 0) {
    throw errcode(new Error('recursion limit exceeded'), 'ERR_DNSLINK_RECURSION_LIMIT');
  }
  let dnslinkRecord;
  try {
    dnslinkRecord = await resolve(domain);
  } catch (err) {
    if (err.code !== 'ENOTFOUND' && err.code !== 'ERR_DNSLINK_NOT_FOUND' && err.code !== 'ENODATA') {
      throw err;
    }
    if (domain.startsWith('_dnslink.')) {
      dnslinkRecord = await resolve(domain.replace('_dnslink.', ''));
    } else {
      const _dnslinkDomain = `_dnslink.${ domain }`;
      dnslinkRecord = await resolve(_dnslinkDomain);
    }
  }
  const result = dnslinkRecord.replace('dnslink=', '');
  const domainOrCID = result.split('/')[2];
  const isIPFSCID = isIPFS.cid(domainOrCID);
  if (isIPFSCID || !depth) {
    return result;
  }
  return recursiveResolveDnslink(domainOrCID, depth - 1);
}
async function resolve(domain) {
  const DNSLINK_REGEX = /^dnslink=.+$/;
  const records = await promisify(dns.resolveTxt)(domain);
  const dnslinkRecords = records.reduce((rs, r) => rs.concat(r), []).filter(record => DNSLINK_REGEX.test(record));
  if (dnslinkRecords.length === 0) {
    throw errcode(new Error(`No dnslink records found for domain: ${ domain }`), 'ERR_DNSLINK_NOT_FOUND');
  }
  return dnslinkRecords[0];
}