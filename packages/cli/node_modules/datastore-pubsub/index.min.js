(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.DatastorePubsub = factory()}(typeof self !== 'undefined' ? self : this, function () {
var DatastorePubsub=(()=>{var ar=Object.create;var oe=Object.defineProperty;var cr=Object.getOwnPropertyDescriptor;var ur=Object.getOwnPropertyNames;var fr=Object.getPrototypeOf,hr=Object.prototype.hasOwnProperty;var nt=r=>oe(r,"__esModule",{value:!0});var C=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),S=(r,e)=>{nt(r);for(var t in e)oe(r,t,{get:e[t],enumerable:!0})},dr=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ur(e))!hr.call(r,s)&&s!=="default"&&oe(r,s,{get:()=>e[s],enumerable:!(t=cr(e,s))||t.enumerable});return r},x=r=>dr(nt(oe(r!=null?ar(fr(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var le=C((Yn,It)=>{"use strict";function Dt(r,e){for(let t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function ws(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return Dt(r,t)}catch(s){t.message=r.message,t.stack=r.stack;let n=function(){};return n.prototype=Object.create(Object.getPrototypeOf(r)),Dt(new n,t)}}It.exports=ws});var Nt=C((eo,Tt)=>{"use strict";var Es=async r=>{let e=[];for await(let t of r)e.push(t);return e};Tt.exports=Es});var Ge=C((ro,kt)=>{"use strict";var vs=async r=>{for await(let e of r);};kt.exports=vs});var Je=C((so,Lt)=>{"use strict";var Cs=async function*(r,e){for await(let t of r)await e(t)&&(yield t)};Lt.exports=Cs});var Ye=C((no,Ut)=>{"use strict";var Ss=async function*(r,e){let t=0;if(!(e<1)){for await(let s of r)if(yield s,t++,t===e)return}};Ut.exports=Ss});var Kt=C((ho,Pt)=>{"use strict";var Fs=async function*(r,e){for await(let t of r)yield e(t)};Pt.exports=Fs});var zt=C((lo,G)=>{var Bt=(...r)=>{let e;for(;r.length;)e=r.shift()(e);return e},Ze=r=>r&&(typeof r[Symbol.asyncIterator]=="function"||typeof r[Symbol.iterator]=="function"||typeof r.next=="function"),ge=r=>r&&typeof r.sink=="function"&&Ze(r.source),As=r=>e=>(r.sink(e),r.source),Vt=(...r)=>{if(ge(r[0])){let e=r[0];r[0]=()=>e.source}else if(Ze(r[0])){let e=r[0];r[0]=()=>e}if(r.length>1&&ge(r[r.length-1])&&(r[r.length-1]=r[r.length-1].sink),r.length>2)for(let e=1;e<r.length-1;e++)ge(r[e])&&(r[e]=As(r[e]));return Bt(...r)};G.exports=Vt;G.exports.pipe=Vt;G.exports.rawPipe=Bt;G.exports.isIterable=Ze;G.exports.isDuplex=ge});var Wt=C((Fo,$t)=>{$t.exports=class{constructor(e){if(!(e>0)||(e-1&e)!=0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}});var Yt=C((_o,Jt)=>{var Gt=Wt();Jt.exports=class{constructor(e){this.hwm=e||16,this.head=new Gt(this.hwm),this.tail=this.head}push(e){if(!this.head.push(e)){let t=this.head;this.head=t.next=new Gt(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next){let t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}isEmpty(){return this.head.isEmpty()}}});var et=C((Ro,Ht)=>{var qe=Yt();Ht.exports=r=>{r=r||{};let e;typeof r=="function"?(e=r,r={}):e=r.onEnd;let t=new qe,s,n,o,c=()=>{if(!t.isEmpty()){if(r.writev){let f,h=[];for(;!t.isEmpty();){if(f=t.shift(),f.error)throw f.error;h.push(f.value)}return{done:f.done,value:h}}let i=t.shift();if(i.error)throw i.error;return i}return o?{done:!0}:new Promise((i,f)=>{n=h=>(n=null,h.error?f(h.error):r.writev&&!h.done?i({done:h.done,value:[h.value]}):i(h),s)})},d=i=>n?n(i):(t.push(i),s),b=i=>(t=new qe,n?n({error:i}):(t.push({error:i}),s)),j=i=>o?s:d({done:!1,value:i}),a=i=>o?s:(o=!0,i?b(i):d({done:!0})),u=()=>(t=new qe,a(),{done:!0}),l=i=>(a(i),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:u,throw:l,push:j,end:a},!e)return s;let M=s;return s={[Symbol.asyncIterator](){return this},next(){return M.next()},throw(i){return M.throw(i),e&&(e(i),e=null),{done:!0}},return(){return M.return(),e&&(e(),e=null),{done:!0}},push:j,end(i){return M.end(i),e&&(e(i),e=null),s}},s}});var Zt=C((Do,Xt)=>{"use strict";var Ds=et(),Is=async function*(...r){let e=Ds();setTimeout(async()=>{try{await Promise.all(r.map(async t=>{for await(let s of t)e.push(s)})),e.end()}catch(t){e.end(t)}},0),yield*e};Xt.exports=Is});var qt=C((Lo,Qt)=>{var J=1e3,Y=J*60,H=Y*60,K=H*24,Ns=K*7,Os=K*365.25;Qt.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return ks(r);if(t==="number"&&isFinite(r))return e.long?Us(r):Ls(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function ks(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!!e){var t=parseFloat(e[1]),s=(e[2]||"ms").toLowerCase();switch(s){case"years":case"year":case"yrs":case"yr":case"y":return t*Os;case"weeks":case"week":case"w":return t*Ns;case"days":case"day":case"d":return t*K;case"hours":case"hour":case"hrs":case"hr":case"h":return t*H;case"minutes":case"minute":case"mins":case"min":case"m":return t*Y;case"seconds":case"second":case"secs":case"sec":case"s":return t*J;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Ls(r){var e=Math.abs(r);return e>=K?Math.round(r/K)+"d":e>=H?Math.round(r/H)+"h":e>=Y?Math.round(r/Y)+"m":e>=J?Math.round(r/J)+"s":r+"ms"}function Us(r){var e=Math.abs(r);return e>=K?we(r,e,K,"day"):e>=H?we(r,e,H,"hour"):e>=Y?we(r,e,Y,"minute"):e>=J?we(r,e,J,"second"):r+" ms"}function we(r,e,t,s){var n=e>=t*1.5;return Math.round(r/t)+" "+s+(n?"s":"")}});var tr=C((Uo,er)=>{function Ps(r){t.debug=t,t.default=t,t.coerce=b,t.disable=o,t.enable=n,t.enabled=c,t.humanize=qt(),t.destroy=j,Object.keys(r).forEach(a=>{t[a]=r[a]}),t.names=[],t.skips=[],t.formatters={};function e(a){let u=0;for(let l=0;l<a.length;l++)u=(u<<5)-u+a.charCodeAt(l),u|=0;return t.colors[Math.abs(u)%t.colors.length]}t.selectColor=e;function t(a){let u,l=null,M,i;function f(...h){if(!f.enabled)return;let y=f,v=Number(new Date),R=v-(u||v);y.diff=R,y.prev=u,y.curr=v,u=v,h[0]=t.coerce(h[0]),typeof h[0]!="string"&&h.unshift("%O");let w=0;h[0]=h[0].replace(/%([a-zA-Z%])/g,(D,F)=>{if(D==="%%")return"%";w++;let I=t.formatters[F];if(typeof I=="function"){let B=h[w];D=I.call(y,B),h.splice(w,1),w--}return D}),t.formatArgs.call(y,h),(y.log||t.log).apply(y,h)}return f.namespace=a,f.useColors=t.useColors(),f.color=t.selectColor(a),f.extend=s,f.destroy=t.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(M!==t.namespaces&&(M=t.namespaces,i=t.enabled(a)),i),set:h=>{l=h}}),typeof t.init=="function"&&t.init(f),f}function s(a,u){let l=t(this.namespace+(typeof u=="undefined"?":":u)+a);return l.log=this.log,l}function n(a){t.save(a),t.namespaces=a,t.names=[],t.skips=[];let u,l=(typeof a=="string"?a:"").split(/[\s,]+/),M=l.length;for(u=0;u<M;u++)!l[u]||(a=l[u].replace(/\*/g,".*?"),a[0]==="-"?t.skips.push(new RegExp("^"+a.substr(1)+"$")):t.names.push(new RegExp("^"+a+"$")))}function o(){let a=[...t.names.map(d),...t.skips.map(d).map(u=>"-"+u)].join(",");return t.enable(""),a}function c(a){if(a[a.length-1]==="*")return!0;let u,l;for(u=0,l=t.skips.length;u<l;u++)if(t.skips[u].test(a))return!1;for(u=0,l=t.names.length;u<l;u++)if(t.names[u].test(a))return!0;return!1}function d(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function b(a){return a instanceof Error?a.stack||a.message:a}function j(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}er.exports=Ps});var tt=C((A,xe)=>{A.formatArgs=Bs;A.save=Vs;A.load=zs;A.useColors=Ks;A.storage=$s();A.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();A.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Ks(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Bs(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+xe.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,s=0;r[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(t++,n==="%c"&&(s=t))}),r.splice(s,0,e)}A.log=console.debug||console.log||(()=>{});function Vs(r){try{r?A.storage.setItem("debug",r):A.storage.removeItem("debug")}catch(e){}}function zs(){let r;try{r=A.storage.getItem("debug")}catch(e){}return!r&&typeof process!="undefined"&&"env"in process&&(r=process.env.DEBUG),r}function $s(){try{return localStorage}catch(r){}}xe.exports=tr()(A);var{formatters:Ws}=xe.exports;Ws.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Ys={};S(Ys,{PubsubDatastore:()=>ir});var ot=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r));for(;r--;){let s=t[r]&63;s<36?e+=s.toString(36):s<62?e+=(s-26).toString(36).toUpperCase():s<63?e+="_":e+="-"}return e};var ve={};S(ve,{identity:()=>gr});function lr(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var n=0;n<r.length;n++){var o=r.charAt(n),c=o.charCodeAt(0);if(t[c]!==255)throw new TypeError(o+" is ambiguous");t[c]=n}var d=r.length,b=r.charAt(0),j=Math.log(d)/Math.log(256),a=Math.log(256)/Math.log(d);function u(i){if(i instanceof Uint8Array||(ArrayBuffer.isView(i)?i=new Uint8Array(i.buffer,i.byteOffset,i.byteLength):Array.isArray(i)&&(i=Uint8Array.from(i))),!(i instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(i.length===0)return"";for(var f=0,h=0,y=0,v=i.length;y!==v&&i[y]===0;)y++,f++;for(var R=(v-y)*a+1>>>0,w=new Uint8Array(R);y!==v;){for(var T=i[y],D=0,F=R-1;(T!==0||D<h)&&F!==-1;F--,D++)T+=256*w[F]>>>0,w[F]=T%d>>>0,T=T/d>>>0;if(T!==0)throw new Error("Non-zero carry");h=D,y++}for(var I=R-h;I!==R&&w[I]===0;)I++;for(var B=b.repeat(f);I<R;++I)B+=r.charAt(w[I]);return B}function l(i){if(typeof i!="string")throw new TypeError("Expected String");if(i.length===0)return new Uint8Array;var f=0;if(i[f]!==" "){for(var h=0,y=0;i[f]===b;)h++,f++;for(var v=(i.length-f)*j+1>>>0,R=new Uint8Array(v);i[f];){var w=t[i.charCodeAt(f)];if(w===255)return;for(var T=0,D=v-1;(w!==0||T<y)&&D!==-1;D--,T++)w+=d*R[D]>>>0,R[D]=w%256>>>0,w=w/256>>>0;if(w!==0)throw new Error("Non-zero carry");y=T,f++}if(i[f]!==" "){for(var F=v-y;F!==v&&R[F]===0;)F++;for(var I=new Uint8Array(h+(v-F)),B=h;F!==v;)I[B++]=R[F++];return I}}}function M(i){var f=l(i);if(f)return f;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:l,decode:M}}var pr=lr,mr=pr,it=mr;var tn=new Uint8Array(0);var at=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},O=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var ct=r=>new TextEncoder().encode(r),ut=r=>new TextDecoder().decode(r);var ht=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},dt=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseDecode=s}decode(e){if(typeof e=="string")switch(e[0]){case this.prefix:return this.baseDecode(e.slice(1));default:throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`)}else throw Error("Can only multibase decode strings")}or(e){let t={[this.prefix]:this,...e.decoders||{[e.prefix]:e}};return new ie(t)}},ie=class{constructor(e){this.decoders=e}or(e){let t=e.decoders||{[e.prefix]:e};return new ie({...this.decoders,...t})}decode(e){let t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},lt=class{constructor(e,t,s,n){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=n,this.encoder=new ht(e,t,s),this.decoder=new dt(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},ae=({name:r,prefix:e,encode:t,decode:s})=>new lt(r,e,t,s),U=({prefix:r,name:e,alphabet:t})=>{let{encode:s,decode:n}=it(t,e);return ae({prefix:r,name:e,encode:s,decode:o=>O(n(o))})},yr=(r,e,t,s)=>{let n={};for(let a=0;a<e.length;++a)n[e[a]]=a;let o=r.length;for(;r[o-1]==="=";)--o;let c=new Uint8Array(o*t/8|0),d=0,b=0,j=0;for(let a=0;a<o;++a){let u=n[r[a]];if(u===void 0)throw new SyntaxError(`Non-${s} character`);b=b<<t|u,d+=t,d>=8&&(d-=8,c[j++]=255&b>>d)}if(d>=t||255&b<<8-d)throw new SyntaxError("Unexpected end of data");return c},br=(r,e,t)=>{let s=e[e.length-1]==="=",n=(1<<t)-1,o="",c=0,d=0;for(let b=0;b<r.length;++b)for(d=d<<8|r[b],c+=8;c>t;)c-=t,o+=e[n&d>>c];if(c&&(o+=e[n&d<<t-c]),s)for(;o.length*t&7;)o+="=";return o},m=({name:r,prefix:e,bitsPerChar:t,alphabet:s})=>ae({prefix:e,name:r,encode(n){return br(n,s,t)},decode(n){return yr(n,s,t,r)}});var gr=ae({prefix:"\0",name:"identity",encode:r=>ut(r),decode:r=>ct(r)});var Ce={};S(Ce,{base2:()=>wr});var wr=m({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Se={};S(Se,{base8:()=>xr});var xr=m({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Fe={};S(Fe,{base10:()=>Er});var Er=U({prefix:"9",name:"base10",alphabet:"0123456789"});var Ae={};S(Ae,{base16:()=>vr,base16upper:()=>Cr});var vr=m({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Cr=m({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var _e={};S(_e,{base32:()=>V,base32hex:()=>_r,base32hexpad:()=>Dr,base32hexpadupper:()=>Ir,base32hexupper:()=>Rr,base32pad:()=>Fr,base32padupper:()=>Ar,base32upper:()=>Sr,base32z:()=>jr});var V=m({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Sr=m({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Fr=m({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ar=m({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),_r=m({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Rr=m({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Dr=m({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ir=m({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),jr=m({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Re={};S(Re,{base36:()=>Mr,base36upper:()=>Tr});var Mr=U({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Tr=U({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var De={};S(De,{base58btc:()=>N,base58flickr:()=>Nr});var N=U({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Nr=U({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ie={};S(Ie,{base64:()=>Or,base64pad:()=>kr,base64url:()=>Lr,base64urlpad:()=>Ur});var Or=m({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),kr=m({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Lr=m({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ur=m({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Me={};S(Me,{sha256:()=>ss,sha512:()=>ns});var Pr=mt,pt=128,Kr=127,Br=~Kr,Vr=Math.pow(2,31);function mt(r,e,t){e=e||[],t=t||0;for(var s=t;r>=Vr;)e[t++]=r&255|pt,r/=128;for(;r&Br;)e[t++]=r&255|pt,r>>>=7;return e[t]=r|0,mt.bytes=t-s+1,e}var zr=je,$r=128,yt=127;function je(r,e){var t=0,e=e||0,s=0,n=e,o,c=r.length;do{if(n>=c)throw je.bytes=0,new RangeError("Could not decode varint");o=r[n++],t+=s<28?(o&yt)<<s:(o&yt)*Math.pow(2,s),s+=7}while(o>=$r);return je.bytes=n-e,t}var Wr=Math.pow(2,7),Gr=Math.pow(2,14),Jr=Math.pow(2,21),Yr=Math.pow(2,28),Hr=Math.pow(2,35),Xr=Math.pow(2,42),Zr=Math.pow(2,49),Qr=Math.pow(2,56),qr=Math.pow(2,63),es=function(r){return r<Wr?1:r<Gr?2:r<Jr?3:r<Yr?4:r<Hr?5:r<Xr?6:r<Zr?7:r<Qr?8:r<qr?9:10},ts={encode:Pr,decode:zr,encodingLength:es},rs=ts,X=rs;var Z=r=>[X.decode(r),X.decode.bytes],z=(r,e,t=0)=>(X.encode(r,e,t),e),$=r=>X.encodingLength(r);var ce=(r,e)=>{let t=e.byteLength,s=$(r),n=s+$(t),o=new Uint8Array(n+t);return z(r,o,0),z(t,o,s),o.set(e,n),new Q(r,t,e,o)},gt=r=>{let e=O(r),[t,s]=Z(e),[n,o]=Z(e.subarray(s)),c=e.subarray(s+o);if(c.byteLength!==n)throw new Error("Incorrect length");return new Q(t,n,c,e)},wt=(r,e)=>r===e?!0:r.code===e.code&&r.size===e.size&&at(r.bytes,e.bytes),Q=class{constructor(e,t,s,n){this.code=e,this.size=t,this.digest=s,this.bytes=n}};var q=({name:r,code:e,encode:t})=>new Et(r,e,t),Et=class{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}async digest(e){if(e instanceof Uint8Array){let t=await this.encode(e);return ce(this.code,t)}else throw Error("Unknown type, must be binary type")}};var Ct=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),ss=q({name:"sha2-256",code:18,encode:Ct("SHA-256")}),ns=q({name:"sha2-512",code:19,encode:Ct("SHA-512")});var Te={};S(Te,{identity:()=>os});var os=q({name:"identity",code:0,encode:r=>O(r)});var g=class{constructor(e,t,s,n){this.code=t,this.version=e,this.multihash=s,this.bytes=n,this.byteOffset=n.byteOffset,this.byteLength=n.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:fe,byteLength:fe,code:ue,version:ue,multihash:ue,bytes:ue,_baseCache:fe,asCID:fe})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:t}=this;if(e!==ee)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==hs)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return g.createV0(t)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,s=ce(e,t);return g.createV1(this.code,s)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&wt(this.multihash,e.multihash)}toString(e){let{bytes:t,version:s,_baseCache:n}=this;switch(s){case 0:return us(t,n,e||N.encoder);default:return fs(t,n,e||V.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return ls(/^0\.0/,ps),!!(e&&(e[Ft]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof g)return e;if(e!=null&&e.asCID===e){let{version:t,code:s,multihash:n,bytes:o}=e;return new g(t,s,n,o||St(t,s,n.bytes))}else if(e!=null&&e[Ft]===!0){let{version:t,multihash:s,code:n}=e,o=gt(s);return g.create(t,n,o)}else return null}static create(e,t,s){if(typeof t!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(t!==ee)throw new Error(`Version 0 CID must use dag-pb (code: ${ee}) block encoding`);return new g(e,t,s,s.bytes)}case 1:{let n=St(e,t,s.bytes);return new g(e,t,s,n)}default:throw new Error("Invalid version")}}static createV0(e){return g.create(0,ee,e)}static createV1(e,t){return g.create(1,e,t)}static decode(e){let[t,s]=g.decodeFirst(e);if(s.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=g.inspectBytes(e),s=t.size-t.multihashSize,n=O(e.subarray(s,s+t.multihashSize));if(n.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=n.subarray(t.multihashSize-t.digestSize),c=new Q(t.multihashCode,t.digestSize,o,n);return[t.version===0?g.createV0(c):g.createV1(t.codec,c),e.subarray(t.size)]}static inspectBytes(e){let t=0,s=()=>{let[u,l]=Z(e.subarray(t));return t+=l,u},n=s(),o=ee;if(n===18?(n=0,t=0):n===1&&(o=s()),n!==0&&n!==1)throw new RangeError(`Invalid CID version ${n}`);let c=t,d=s(),b=s(),j=t+b,a=j-c;return{version:n,codec:o,multihashCode:d,digestSize:b,multihashSize:a,size:j}}static parse(e,t){let[s,n]=cs(e,t),o=g.decode(n);return o._baseCache.set(s,e),o}},cs=(r,e)=>{switch(r[0]){case"Q":{let t=e||N;return[N.prefix,t.decode(`${N.prefix}${r}`)]}case N.prefix:{let t=e||N;return[N.prefix,t.decode(r)]}case V.prefix:{let t=e||V;return[V.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},us=(r,e,t)=>{let{prefix:s}=t;if(s!==N.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let n=e.get(s);if(n==null){let o=t.encode(r).slice(1);return e.set(s,o),o}else return n},fs=(r,e,t)=>{let{prefix:s}=t,n=e.get(s);if(n==null){let o=t.encode(r);return e.set(s,o),o}else return n},ee=112,hs=18,St=(r,e,t)=>{let s=$(r),n=s+$(e),o=new Uint8Array(n+t.byteLength);return z(r,o,0),z(e,o,s),o.set(t,n),o},Ft=Symbol.for("@ipld/js-cid/CID"),ue={writable:!1,configurable:!1,enumerable:!0},fe={writable:!1,enumerable:!1,configurable:!1},ds="0.0.0-dev",ls=(r,e)=>{if(r.test(ds))console.warn(e);else throw new Error(e)},ps=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`;var Ne={...ve,...Ce,...Se,...Fe,...Ae,..._e,...Re,...De,...Ie},Nn={...Me,...Te};function At(r,e,t,s){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:s}}}var _t=At("utf8","u",r=>{let e=new TextDecoder("utf8");return"u"+e.decode(r)},r=>new TextEncoder().encode(r.substring(1))),Oe=At("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=new Uint8Array(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),ms={utf8:_t,"utf-8":_t,hex:Ne.base16,latin1:Oe,ascii:Oe,binary:Oe,...Ne},he=ms;function te(r,e="utf8"){let t=he[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}function re(r,e="utf8"){let t=he[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}var k="/",Rt=new TextEncoder().encode(k),de=Rt[0],p=class{constructor(e,t){if(typeof e=="string")this._buf=re(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==de)throw new Error("Invalid key")}toString(e="utf8"){return te(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new p(e.join(k))}static random(){return new p(ot().replace(/-/g,""))}clean(){if((!this._buf||this._buf.byteLength===0)&&(this._buf=Rt),this._buf[0]!==de){let e=new Uint8Array(this._buf.byteLength+1);e.fill(de,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===de;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),s=e.list();for(let n=0;n<t.length;n++){if(s.length<n+1)return!1;let o=t[n],c=s[n];if(o<c)return!0;if(o>c)return!1}return t.length<s.length}reverse(){return p.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(k).slice(1)}type(){return ys(this.baseNamespace())}name(){return bs(this.baseNamespace())}instance(e){return new p(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(k)||(e+=k),e+=this.type(),new p(e)}parent(){let e=this.list();return e.length===1?new p(k):new p(e.slice(0,-1).join(k))}child(e){return this.toString()===k?e:e.toString()===k?this:new p(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return p.withNamespaces([...this.namespaces(),...gs(e.map(t=>t.namespaces()))])}};function ys(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function bs(r){let e=r.split(":");return e[e.length-1]}function gs(r){return[].concat(...r)}var Pe={};S(Pe,{abortedError:()=>xs,dbDeleteFailedError:()=>Le,dbOpenFailedError:()=>ke,dbWriteFailedError:()=>Ue,notFoundError:()=>pe});var W=x(le());function ke(r){return r=r||new Error("Cannot open database"),(0,W.default)(r,"ERR_DB_OPEN_FAILED")}function Le(r){return r=r||new Error("Delete failed"),(0,W.default)(r,"ERR_DB_DELETE_FAILED")}function Ue(r){return r=r||new Error("Write failed"),(0,W.default)(r,"ERR_DB_WRITE_FAILED")}function pe(r){return r=r||new Error("Not Found"),(0,W.default)(r,"ERR_NOT_FOUND")}function xs(r){return r=r||new Error("Aborted"),(0,W.default)(r,"ERR_ABORTED")}var We={};S(We,{NextToLast:()=>$e,PREFIX:()=>me,Prefix:()=>Ve,README_FN:()=>Be,SHARDING_FN:()=>ye,ShardBase:()=>se,Suffix:()=>ze,parseShardFun:()=>jt,readShardFun:()=>Mt,readme:()=>Ke});var Ke=`This is a repository of IPLD objects. Each IPLD object is in a single file,
named <base32 encoding of cid>.data. Where <base32 encoding of cid> is the
"base32" encoding of the CID (as specified in
https://github.com/multiformats/multibase) without the 'B' prefix.
All the object files are placed in a tree of directories, based on a
function of the CID. This is a form of sharding similar to
the objects directory in git repositories. Previously, we used
prefixes, we now use the next-to-last two charters.
    func NextToLast(base32cid string) {
      nextToLastLen := 2
      offset := len(base32cid) - nextToLastLen - 1
      return str[offset : offset+nextToLastLen]
    }
For example, an object with a base58 CIDv1 of
    zb2rhYSxw4ZjuzgCnWSt19Q94ERaeFhu9uSqRgjSdx9bsgM6f
has a base32 CIDv1 of
    BAFKREIA22FLID5AJ2KU7URG47MDLROZIH6YF2KALU2PWEFPVI37YLKRSCA
and will be placed at
    SC/AFKREIA22FLID5AJ2KU7URG47MDLROZIH6YF2KALU2PWEFPVI37YLKRSCA.data
with 'SC' being the last-to-next two characters and the 'B' at the
beginning of the CIDv1 string is the multibase prefix that is not
stored in the filename.
`;var me="/repo/flatfs/shard/",ye="SHARDING",Be="_README",se=class{constructor(e){this.param=e,this.name="base",this._padding=""}fun(e){return"implement me"}toString(){return`${me}v1/${this.name}/${this.param}`}},Ve=class extends se{constructor(e){super(e);this._padding="".padStart(e,"_"),this.name="prefix"}fun(e){return(e+this._padding).slice(0,this.param)}},ze=class extends se{constructor(e){super(e);this._padding="".padStart(e,"_"),this.name="suffix"}fun(e){let t=this._padding+e;return t.slice(t.length-this.param)}},$e=class extends se{constructor(e){super(e);this._padding="".padStart(e+1,"_"),this.name="next-to-last"}fun(e){let t=this._padding+e,s=t.length-this.param-1;return t.slice(s,s+this.param)}};function jt(r){if(r=r.trim(),r.length===0)throw new Error("empty shard string");if(!r.startsWith(me))throw new Error(`invalid or no path prefix: ${r}`);let e=r.slice(me.length).split("/"),t=e[0];if(t!=="v1")throw new Error(`expect 'v1' version, got '${t}'`);let s=e[1];if(!e[2])throw new Error("missing param");let n=parseInt(e[2],10);switch(s){case"prefix":return new Ve(n);case"suffix":return new ze(n);case"next-to-last":return new $e(n);default:throw new Error(`unkown sharding function: ${s}`)}}var Mt=async(r,e)=>{let t=new p(r).child(new p(ye)),n=await(typeof e.getRaw=="function"?e.getRaw.bind(e):e.get.bind(e))(t);return jt(new TextDecoder().decode(n||"").trim())};var Ot=x(Nt()),be=(r,e)=>async function*(){yield*(await(0,Ot.default)(r)).sort(e)}();var He=x(Ge()),P=x(Je()),Xe=x(Ye()),L=class{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,s){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:s,value:n}of e)await this.put(s,n,t),yield{key:s,value:n}}async*getMany(e,t={}){for await(let s of e)yield this.get(s,t)}async*deleteMany(e,t={}){for await(let s of e)await this.delete(s,t),yield s}batch(){let e=[],t=[];return{put(s,n){e.push({key:s,value:n})},delete(s){t.push(s)},commit:async s=>{await(0,He.default)(this.putMany(e,s)),e=[],await(0,He.default)(this.deleteMany(t,s)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let s=this._all(e,t);if(e.prefix!=null&&(s=(0,P.default)(s,n=>n.key.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(s=e.filters.reduce((n,o)=>(0,P.default)(n,o),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((n,o)=>be(n,o),s)),e.offset!=null){let n=0;s=(0,P.default)(s,()=>n++>=e.offset)}return e.limit!=null&&(s=(0,Xe.default)(s,e.limit)),s}queryKeys(e,t){let s=this._allKeys(e,t);if(e.prefix!=null&&(s=(0,P.default)(s,n=>n.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(s=e.filters.reduce((n,o)=>(0,P.default)(n,o),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((n,o)=>be(n,o),s)),e.offset!=null){let n=0;s=(0,P.default)(s,()=>n++>=e.offset)}return e.limit!=null&&(s=(0,Xe.default)(s,e.limit)),s}};var _s=x(Kt()),Rs=x(zt());var Eo=new p(ye),vo=new p(Be);var js=x(Je()),Ms=x(Ye()),Ts=x(Zt());var rr=x(tt()),Gs=x(et()),Js=x(Ge()),Bo=(0,rr.default)("datastore:core:tiered");var Zo={...Pe},Qo={...We};var sr=x(le());var Ee="/record/";function rt(r){return te(r,"base32")}function ne(r){(typeof r=="string"||r instanceof String)&&(r=re(r.toString()));let e=te(r,"base64url");return`${Ee}${e}`}function nr(r){if(r.substring(0,Ee.length)!==Ee)throw(0,sr.default)(new Error("topic received is not from a record"),"ERR_TOPIC_IS_NOT_FROM_RECORD_NAMESPACE");let e=r.substring(Ee.length);return re(e,"base64url")}function or(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var _=x(le()),st=x(tt()),E=Object.assign((0,st.default)("datastore-pubsub:publisher"),{error:(0,st.default)("datastore-pubsub:publisher:error")}),ir=class extends L{constructor(e,t,s,n,o){super();if(!n)throw(0,_.default)(new TypeError("missing validator"),"ERR_INVALID_PARAMETERS");if(typeof n.validate!="function")throw(0,_.default)(new TypeError("missing validate function"),"ERR_INVALID_PARAMETERS");if(typeof n.select!="function")throw(0,_.default)(new TypeError("missing select function"),"ERR_INVALID_PARAMETERS");if(o&&typeof o!="function")throw(0,_.default)(new TypeError("invalid subscriptionKeyFn received"),"ERR_INVALID_PARAMETERS");this._pubsub=e,this._datastore=t,this._peerId=s,this._validator=n,this._handleSubscriptionKeyFn=o,this._onMessage=this._onMessage.bind(this)}async put(e,t){if(!(e instanceof Uint8Array)){let n="datastore key does not have a valid format";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_DATASTORE_KEY")}if(!(t instanceof Uint8Array)){let n="received value is not a Uint8Array";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_VALUE_RECEIVED")}let s=ne(e);E(`publish value for topic ${s}`),await this._pubsub.publish(s,t)}async get(e){if(!(e instanceof Uint8Array)){let n="datastore key does not have a valid format";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_DATASTORE_KEY")}let t=ne(e),s=await this._pubsub.getTopics();if(s&&Array.isArray(s)&&s.indexOf(t)>-1)return this._getLocal(e);try{this._pubsub.on(t,this._onMessage),await this._pubsub.subscribe(t)}catch(n){let o=`cannot subscribe topic ${t}`;throw E.error(o),(0,_.default)(new Error(o),"ERR_SUBSCRIBING_TOPIC")}return E(`subscribed values for key ${t}`),this._getLocal(e)}unsubscribe(e){let t=ne(e);return this._pubsub.removeListener(t,this._onMessage),this._pubsub.unsubscribe(t)}async _getLocal(e){let t=new p("/"+rt(e),!1),s;try{s=await this._datastore.get(t)}catch(n){if(n.code!=="ERR_NOT_FOUND"){let c=`unexpected error getting the ipns record for ${t.toString()}`;throw E.error(c),(0,_.default)(new Error(c),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}let o=`local record requested was not found for ${t.toString()}`;throw E.error(o),(0,_.default)(new Error(o),"ERR_NOT_FOUND")}if(!(s instanceof Uint8Array)){let n="found record that we couldn't convert to a value";throw E.error(n),(0,_.default)(new Error(n),"ERR_INVALID_RECORD_RECEIVED")}return s}async _onMessage(e){let{data:t,from:s,topicIDs:n}=e,o;try{o=nr(n[0])}catch(c){E.error(c);return}if(E(`message received for topic ${n[0]}`),s===this._peerId.toB58String()){E("message discarded as it is from the same peer");return}if(this._handleSubscriptionKeyFn){let c;try{c=await this._handleSubscriptionKeyFn(o)}catch(d){E.error("message discarded by the subscriptionKeyFn");return}o=c}try{await this._storeIfSubscriptionIsBetter(o,t)}catch(c){E.error(c)}}async _storeIfSubscriptionIsBetter(e,t){let s=!1;try{s=await this._isBetter(e,t)}catch(n){if(n.code!=="ERR_NOT_VALID_RECORD")throw n}s&&await this._storeRecord(e,t)}async _validateRecord(e,t){return this._validator.validate(e,t)}async _selectRecord(e,t){return await this._validator.select(e,t)===0}async _isBetter(e,t){try{await this._validateRecord(t,e)}catch(o){let c="record received through pubsub is not valid";throw E.error(c),(0,_.default)(new Error(c),"ERR_NOT_VALID_RECORD")}let s=new p(e),n;try{n=await this._getLocal(s.uint8Array())}catch(o){return!0}return or(n,t)?!1:this._selectRecord(e,[n,t])}async _storeRecord(e,t){let s=new p("/"+rt(e),!1);await this._datastore.put(s,t),E(`record for ${ne(e)} was stored in the datastore`)}};return Ys;})();
return DatastorePubsub}));
