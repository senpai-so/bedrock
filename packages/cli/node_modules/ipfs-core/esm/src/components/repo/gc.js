import debug from 'debug';
import { withTimeoutOption } from 'ipfs-core-utils/with-timeout-option';
import { loadMfsRoot } from '../files/utils/with-mfs-root.js';
const log = debug('ipfs:repo:gc');
export function createGc({repo, hashers}) {
  async function* gc(options = {}) {
    const start = Date.now();
    let mfsRootCid;
    try {
      mfsRootCid = await loadMfsRoot({
        repo,
        hashers
      }, options);
      await repo.pins.pinRecursively(mfsRootCid);
      yield* repo.gc();
    } finally {
      if (mfsRootCid) {
        await repo.pins.unpin(mfsRootCid);
      }
    }
    log(`Complete (${ Date.now() - start }ms)`);
  }
  return withTimeoutOption(gc);
}