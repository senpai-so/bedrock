(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.BlockstoreDatastoreAdapter = factory()}(typeof self !== 'undefined' ? self : this, function () {
var BlockstoreDatastoreAdapter=(()=>{var gt=Object.create;var X=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var vt=Object.getOwnPropertyNames;var St=Object.getPrototypeOf,Et=Object.prototype.hasOwnProperty;var Ce=r=>X(r,"__esModule",{value:!0});var Br=typeof require!="undefined"?require:r=>{throw new Error('Dynamic require of "'+r+'" is not supported')};var N=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),w=(r,e)=>{Ce(r);for(var t in e)X(r,t,{get:e[t],enumerable:!0})},jt=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of vt(e))!Et.call(r,s)&&s!=="default"&&X(r,s,{get:()=>e[s],enumerable:!(t=xt(e,s))||t.enumerable});return r},O=r=>jt(Ce(X(r!=null?gt(St(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var re=N((Pr,Ae)=>{"use strict";var Ct=async r=>{for await(let e of r);};Ae.exports=Ct});var Ie=N((Rr,De)=>{De.exports=class{constructor(e){if(!(e>0)||(e-1&e)!=0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}});var Ne=N((Jr,Ue)=>{var ke=Ie();Ue.exports=class{constructor(e){this.hwm=e||16,this.head=new ke(this.hwm),this.tail=this.head}push(e){if(!this.head.push(e)){let t=this.head;this.head=t.next=new ke(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next){let t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}isEmpty(){return this.head.isEmpty()}}});var Me=N((Wr,Te)=>{var se=Ne();Te.exports=r=>{r=r||{};let e;typeof r=="function"?(e=r,r={}):e=r.onEnd;let t=new se,s,n,o,a=()=>{if(!t.isEmpty()){if(r.writev){let f,l=[];for(;!t.isEmpty();){if(f=t.shift(),f.error)throw f.error;l.push(f.value)}return{done:f.done,value:l}}let i=t.shift();if(i.error)throw i.error;return i}return o?{done:!0}:new Promise((i,f)=>{n=l=>(n=null,l.error?f(l.error):r.writev&&!l.done?i({done:l.done,value:[l.value]}):i(l),s)})},c=i=>n?n(i):(t.push(i),s),u=i=>(t=new se,n?n({error:i}):(t.push({error:i}),s)),C=i=>o?s:c({done:!1,value:i}),p=i=>o?s:(o=!0,i?u(i):c({done:!0})),k=()=>(t=new se,p(),{done:!0}),z=i=>(p(i),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:a,return:k,throw:z,push:C,end:p},!e)return s;let F=s;return s={[Symbol.asyncIterator](){return this},next(){return F.next()},throw(i){return F.throw(i),e&&(e(i),e=null),{done:!0}},return(){return F.return(),e&&(e(),e=null),{done:!0}},push:C,end(i){return F.end(i),e&&(e(i),e=null),s}},s}});var ct=N(($s,at)=>{"use strict";function it(r,e){for(let t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function Nr(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return it(r,t)}catch(s){t.message=r.message,t.stack=r.stack;let n=function(){};return n.prototype=Object.create(Object.getPrototypeOf(r)),it(new n,t)}}at.exports=Nr});var dt=N((Js,ft)=>{"use strict";var Tr=async function*(r,e){for await(let t of r)await e(t)&&(yield t)};ft.exports=Tr});var ut=N((Ws,ht)=>{"use strict";var Mr=async function*(r,e){let t=0;if(!(e<1)){for await(let s of r)if(yield s,t++,t===e)return}};ht.exports=Mr});var pt=N((Qs,lt)=>{"use strict";var Or=async r=>{let e=[];for await(let t of r)e.push(t);return e};lt.exports=Or});var Fr={};w(Fr,{BlockstoreDatastoreAdapter:()=>wt});var Se=O(re()),Ee=O(Me());var Oe=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r));for(;r--;){let s=t[r]&63;s<36?e+=s.toString(36):s<62?e+=(s-26).toString(36).toUpperCase():s<63?e+="_":e+="-"}return e};var ne={};w(ne,{identity:()=>Nt});function At(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var n=0;n<r.length;n++){var o=r.charAt(n),a=o.charCodeAt(0);if(t[a]!==255)throw new TypeError(o+" is ambiguous");t[a]=n}var c=r.length,u=r.charAt(0),C=Math.log(c)/Math.log(256),p=Math.log(256)/Math.log(c);function k(i){if(i instanceof Uint8Array||(ArrayBuffer.isView(i)?i=new Uint8Array(i.buffer,i.byteOffset,i.byteLength):Array.isArray(i)&&(i=Uint8Array.from(i))),!(i instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(i.length===0)return"";for(var f=0,l=0,x=0,S=i.length;x!==S&&i[x]===0;)x++,f++;for(var E=(S-x)*p+1>>>0,y=new Uint8Array(E);x!==S;){for(var j=i[x],U=0,v=E-1;(j!==0||U<l)&&v!==-1;v--,U++)j+=256*y[v]>>>0,y[v]=j%c>>>0,j=j/c>>>0;if(j!==0)throw new Error("Non-zero carry");l=U,x++}for(var A=E-l;A!==E&&y[A]===0;)A++;for(var Q=u.repeat(f);A<E;++A)Q+=r.charAt(y[A]);return Q}function z(i){if(typeof i!="string")throw new TypeError("Expected String");if(i.length===0)return new Uint8Array;var f=0;if(i[f]!==" "){for(var l=0,x=0;i[f]===u;)l++,f++;for(var S=(i.length-f)*C+1>>>0,E=new Uint8Array(S);i[f];){var y=t[i.charCodeAt(f)];if(y===255)return;for(var j=0,U=S-1;(y!==0||j<x)&&U!==-1;U--,j++)y+=c*E[U]>>>0,E[U]=y%256>>>0,y=y/256>>>0;if(y!==0)throw new Error("Non-zero carry");x=j,f++}if(i[f]!==" "){for(var v=S-x;v!==S&&E[v]===0;)v++;for(var A=new Uint8Array(l+(S-v)),Q=l;v!==S;)A[Q++]=E[v++];return A}}}function F(i){var f=z(i);if(f)return f;throw new Error(`Non-${e} character`)}return{encode:k,decodeUnsafe:z,decode:F}}var Dt=At,It=Dt,Le=It;var Yr=new Uint8Array(0);var ze=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},D=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var Fe=r=>new TextEncoder().encode(r),Be=r=>new TextDecoder().decode(r);var Pe=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},_e=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseDecode=s}decode(e){if(typeof e=="string")switch(e[0]){case this.prefix:return this.baseDecode(e.slice(1));default:throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`)}else throw Error("Can only multibase decode strings")}or(e){let t={[this.prefix]:this,...e.decoders||{[e.prefix]:e}};return new K(t)}},K=class{constructor(e){this.decoders=e}or(e){let t=e.decoders||{[e.prefix]:e};return new K({...this.decoders,...t})}decode(e){let t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Re=class{constructor(e,t,s,n){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=n,this.encoder=new Pe(e,t,s),this.decoder=new _e(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},G=({name:r,prefix:e,encode:t,decode:s})=>new Re(r,e,t,s),T=({prefix:r,name:e,alphabet:t})=>{let{encode:s,decode:n}=Le(t,e);return G({prefix:r,name:e,encode:s,decode:o=>D(n(o))})},kt=(r,e,t,s)=>{let n={};for(let p=0;p<e.length;++p)n[e[p]]=p;let o=r.length;for(;r[o-1]==="=";)--o;let a=new Uint8Array(o*t/8|0),c=0,u=0,C=0;for(let p=0;p<o;++p){let k=n[r[p]];if(k===void 0)throw new SyntaxError(`Non-${s} character`);u=u<<t|k,c+=t,c>=8&&(c-=8,a[C++]=255&u>>c)}if(c>=t||255&u<<8-c)throw new SyntaxError("Unexpected end of data");return a},Ut=(r,e,t)=>{let s=e[e.length-1]==="=",n=(1<<t)-1,o="",a=0,c=0;for(let u=0;u<r.length;++u)for(c=c<<8|r[u],a+=8;a>t;)a-=t,o+=e[n&c>>a];if(a&&(o+=e[n&c<<t-a]),s)for(;o.length*t&7;)o+="=";return o},d=({name:r,prefix:e,bitsPerChar:t,alphabet:s})=>G({prefix:e,name:r,encode(n){return Ut(n,s,t)},decode(n){return kt(n,s,t,r)}});var Nt=G({prefix:"\0",name:"identity",encode:r=>Be(r),decode:r=>Fe(r)});var oe={};w(oe,{base2:()=>Tt});var Tt=d({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var ie={};w(ie,{base8:()=>Mt});var Mt=d({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var ae={};w(ae,{base10:()=>Ot});var Ot=T({prefix:"9",name:"base10",alphabet:"0123456789"});var ce={};w(ce,{base16:()=>Lt,base16upper:()=>zt});var Lt=d({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),zt=d({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var de={};w(de,{base32:()=>g,base32hex:()=>Vt,base32hexpad:()=>_t,base32hexpadupper:()=>Rt,base32hexupper:()=>Pt,base32pad:()=>fe,base32padupper:()=>Bt,base32upper:()=>Ft,base32z:()=>$t});var g=d({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Ft=d({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),fe=d({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Bt=d({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Vt=d({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Pt=d({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),_t=d({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Rt=d({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$t=d({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var he={};w(he,{base36:()=>Jt,base36upper:()=>Wt});var Jt=T({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Wt=T({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var ue={};w(ue,{base58btc:()=>b,base58flickr:()=>Qt});var b=T({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Qt=T({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var le={};w(le,{base64:()=>Xt,base64pad:()=>Kt,base64url:()=>Gt,base64urlpad:()=>Ht});var Xt=d({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Kt=d({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Gt=d({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ht=d({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var be={};w(be,{sha256:()=>br,sha512:()=>mr});var Yt=Je,$e=128,Zt=127,qt=~Zt,er=Math.pow(2,31);function Je(r,e,t){e=e||[],t=t||0;for(var s=t;r>=er;)e[t++]=r&255|$e,r/=128;for(;r&qt;)e[t++]=r&255|$e,r>>>=7;return e[t]=r|0,Je.bytes=t-s+1,e}var tr=pe,rr=128,We=127;function pe(r,e){var t=0,e=e||0,s=0,n=e,o,a=r.length;do{if(n>=a)throw pe.bytes=0,new RangeError("Could not decode varint");o=r[n++],t+=s<28?(o&We)<<s:(o&We)*Math.pow(2,s),s+=7}while(o>=rr);return pe.bytes=n-e,t}var sr=Math.pow(2,7),nr=Math.pow(2,14),or=Math.pow(2,21),ir=Math.pow(2,28),ar=Math.pow(2,35),cr=Math.pow(2,42),fr=Math.pow(2,49),dr=Math.pow(2,56),hr=Math.pow(2,63),ur=function(r){return r<sr?1:r<nr?2:r<or?3:r<ir?4:r<ar?5:r<cr?6:r<fr?7:r<dr?8:r<hr?9:10},lr={encode:Yt,decode:tr,encodingLength:ur},pr=lr,_=pr;var R=r=>[_.decode(r),_.decode.bytes],B=(r,e,t=0)=>(_.encode(r,e,t),e),V=r=>_.encodingLength(r);var H=(r,e)=>{let t=e.byteLength,s=V(r),n=s+V(t),o=new Uint8Array(n+t);return B(r,o,0),B(t,o,s),o.set(e,n),new $(r,t,e,o)},Y=r=>{let e=D(r),[t,s]=R(e),[n,o]=R(e.subarray(s)),a=e.subarray(s+o);if(a.byteLength!==n)throw new Error("Incorrect length");return new $(t,n,a,e)},Xe=(r,e)=>r===e?!0:r.code===e.code&&r.size===e.size&&ze(r.bytes,e.bytes),$=class{constructor(e,t,s,n){this.code=e,this.size=t,this.digest=s,this.bytes=n}};var J=({name:r,code:e,encode:t})=>new Ge(r,e,t),Ge=class{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}async digest(e){if(e instanceof Uint8Array){let t=await this.encode(e);return H(this.code,t)}else throw Error("Unknown type, must be binary type")}};var Ye=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),br=J({name:"sha2-256",code:18,encode:Ye("SHA-256")}),mr=J({name:"sha2-512",code:19,encode:Ye("SHA-512")});var me={};w(me,{identity:()=>yr});var yr=J({name:"identity",code:0,encode:r=>D(r)});var Ze=85;var xs=new TextEncoder,vs=new TextDecoder;var h=class{constructor(e,t,s,n){this.code=t,this.version=e,this.multihash=s,this.bytes=n,this.byteOffset=n.byteOffset,this.byteLength=n.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:q,byteLength:q,code:Z,version:Z,multihash:Z,bytes:Z,_baseCache:q,asCID:q})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:t}=this;if(e!==W)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Er)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return h.createV0(t)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,s=H(e,t);return h.createV1(this.code,s)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&Xe(this.multihash,e.multihash)}toString(e){let{bytes:t,version:s,_baseCache:n}=this;switch(s){case 0:return vr(t,n,e||b.encoder);default:return Sr(t,n,e||g.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return Cr(/^0\.0/,Ar),!!(e&&(e[et]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof h)return e;if(e!=null&&e.asCID===e){let{version:t,code:s,multihash:n,bytes:o}=e;return new h(t,s,n,o||qe(t,s,n.bytes))}else if(e!=null&&e[et]===!0){let{version:t,multihash:s,code:n}=e,o=Y(s);return h.create(t,n,o)}else return null}static create(e,t,s){if(typeof t!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(t!==W)throw new Error(`Version 0 CID must use dag-pb (code: ${W}) block encoding`);return new h(e,t,s,s.bytes)}case 1:{let n=qe(e,t,s.bytes);return new h(e,t,s,n)}default:throw new Error("Invalid version")}}static createV0(e){return h.create(0,W,e)}static createV1(e,t){return h.create(1,e,t)}static decode(e){let[t,s]=h.decodeFirst(e);if(s.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=h.inspectBytes(e),s=t.size-t.multihashSize,n=D(e.subarray(s,s+t.multihashSize));if(n.byteLength!==t.multihashSize)throw new Error("Incorrect length");let o=n.subarray(t.multihashSize-t.digestSize),a=new $(t.multihashCode,t.digestSize,o,n);return[t.version===0?h.createV0(a):h.createV1(t.codec,a),e.subarray(t.size)]}static inspectBytes(e){let t=0,s=()=>{let[k,z]=R(e.subarray(t));return t+=z,k},n=s(),o=W;if(n===18?(n=0,t=0):n===1&&(o=s()),n!==0&&n!==1)throw new RangeError(`Invalid CID version ${n}`);let a=t,c=s(),u=s(),C=t+u,p=C-a;return{version:n,codec:o,multihashCode:c,digestSize:u,multihashSize:p,size:C}}static parse(e,t){let[s,n]=xr(e,t),o=h.decode(n);return o._baseCache.set(s,e),o}},xr=(r,e)=>{switch(r[0]){case"Q":{let t=e||b;return[b.prefix,t.decode(`${b.prefix}${r}`)]}case b.prefix:{let t=e||b;return[b.prefix,t.decode(r)]}case g.prefix:{let t=e||g;return[g.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},vr=(r,e,t)=>{let{prefix:s}=t;if(s!==b.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let n=e.get(s);if(n==null){let o=t.encode(r).slice(1);return e.set(s,o),o}else return n},Sr=(r,e,t)=>{let{prefix:s}=t,n=e.get(s);if(n==null){let o=t.encode(r);return e.set(s,o),o}else return n},W=112,Er=18,qe=(r,e,t)=>{let s=V(r),n=s+V(e),o=new Uint8Array(n+t.byteLength);return B(r,o,0),B(e,o,s),o.set(t,n),o},et=Symbol.for("@ipld/js-cid/CID"),Z={writable:!1,configurable:!1,enumerable:!0},q={writable:!1,enumerable:!1,configurable:!1},jr="0.0.0-dev",Cr=(r,e)=>{if(r.test(jr))console.warn(e);else throw new Error(e)},Ar=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`;var ye={...ne,...oe,...ie,...ae,...ce,...de,...he,...ue,...le},Ns={...be,...me};function tt(r,e,t,s){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:s}}}var rt=tt("utf8","u",r=>{let e=new TextDecoder("utf8");return"u"+e.decode(r)},r=>new TextEncoder().encode(r.substring(1))),we=tt("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=new Uint8Array(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Dr={utf8:rt,"utf-8":rt,hex:ye.base16,latin1:we,ascii:we,binary:we,...ye},ee=Dr;function st(r,e="utf8"){let t=ee[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}function nt(r,e="utf8"){let t=ee[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}var I="/",ot=new TextEncoder().encode(I),te=ot[0],m=class{constructor(e,t){if(typeof e=="string")this._buf=nt(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==te)throw new Error("Invalid key")}toString(e="utf8"){return st(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new m(e.join(I))}static random(){return new m(Oe().replace(/-/g,""))}clean(){if((!this._buf||this._buf.byteLength===0)&&(this._buf=ot),this._buf[0]!==te){let e=new Uint8Array(this._buf.byteLength+1);e.fill(te,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===te;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),s=e.list();for(let n=0;n<t.length;n++){if(s.length<n+1)return!1;let o=t[n],a=s[n];if(o<a)return!0;if(o>a)return!1}return t.length<s.length}reverse(){return m.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(I).slice(1)}type(){return Ir(this.baseNamespace())}name(){return kr(this.baseNamespace())}instance(e){return new m(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(I)||(e+=I),e+=this.type(),new m(e)}parent(){let e=this.list();return e.length===1?new m(I):new m(e.slice(0,-1).join(I))}child(e){return this.toString()===I?e:e.toString()===I?this:new m(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return m.withNamespaces([...this.namespaces(),...Ur(e.map(t=>t.namespaces()))])}};function Ir(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function kr(r){let e=r.split(":");return e[e.length-1]}function Ur(r){return[].concat(...r)}var yt=O(ct());var ge=O(re()),L=O(dt()),xe=O(ut()),bt=O(pt()),mt=(r,e)=>async function*(){yield*(await(0,bt.default)(r)).sort(e)}(),ve=class{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,s){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:s,value:n}of e)await this.put(s,n,t),yield{key:s,value:n}}async*getMany(e,t={}){for await(let s of e)yield this.get(s,t)}async*deleteMany(e,t={}){for await(let s of e)await this.delete(s,t),yield s}batch(){let e=[],t=[];return{put(s,n){e.push({key:s,value:n})},delete(s){t.push(s)},commit:async s=>{await(0,ge.default)(this.putMany(e,s)),e=[],await(0,ge.default)(this.deleteMany(t,s)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let s=this._all(e,t);if(e.prefix!=null&&(s=(0,L.default)(s,n=>n.key.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(s=e.filters.reduce((n,o)=>(0,L.default)(n,o),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((n,o)=>mt(n,o),s)),e.offset!=null){let n=0;s=(0,L.default)(s,()=>n++>=(e.offset||0))}return e.limit!=null&&(s=(0,xe.default)(s,e.limit)),s}queryKeys(e,t){let s=this._allKeys(e,t);if(e.prefix!=null&&(s=(0,L.default)(s,n=>n.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(s=e.filters.reduce((n,o)=>(0,L.default)(n,o),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((n,o)=>mt(n,o),s)),e.offset!=null){let n=0;s=(0,L.default)(s,()=>n++>=e.offset)}return e.limit!=null&&(s=(0,xe.default)(s,e.limit)),s}};function P(r){let e=h.asCID(r);if(!e)throw(0,yt.default)(new Error("Not a valid cid"),"ERR_INVALID_CID");return new m("/"+g.encode(e.multihash.bytes).slice(1).toUpperCase(),!1)}function M(r){return h.createV1(Ze,Y(g.decode("b"+r.toString().slice(1).toLowerCase())))}function je(r){let e=r.substring(0,1);if(e==="/")return je(r.substring(1));let t;e.toLowerCase()==="b"?t=o=>g.decode(o.toLowerCase()).subarray(2):e.toLowerCase()==="c"?t=o=>fe.decode(o.toLowerCase()).subarray(2):e==="z"?t=o=>b.decode(o).subarray(2):e==="Q"?t=o=>b.decode("z"+o):t=o=>g.decode("b"+o.toLowerCase()).subarray(2);let s;for(let o=1;o<r.length;o++)try{s=t(r.substring(0,o))}catch(a){if(a.message!=="Unexpected end of data")throw a}let n="/C";return s&&(n=`/${g.encode(s).slice(1,-1).toUpperCase()||"C"}`),n}function Lr(r){return{...r,prefix:r.prefix?je(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e({key:M(t.key),value:t.value})):void 0,orders:r.orders?r.orders.map(e=>(t,s)=>e({key:M(t.key),value:t.value},{key:M(s.key),value:s.value})):void 0}}function zr(r){return{...r,prefix:r.prefix?je(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e(M(t))):void 0,orders:r.orders?r.orders.map(e=>(t,s)=>e(M(t),M(s))):void 0}}var wt=class extends ve{constructor(e){super();this.child=e}open(){return this.child.open()}close(){return this.child.close()}async*query(e,t){for await(let{key:s,value:n}of this.child.query(Lr(e),t))yield{key:M(s),value:n}}async*queryKeys(e,t){for await(let s of this.child.queryKeys(zr(e),t))yield M(s)}async get(e,t){return this.child.get(P(e),t)}async*getMany(e,t){for await(let s of e)yield this.get(s,t)}async put(e,t,s){await this.child.put(P(e),t,s)}async*putMany(e,t){let s=(0,Ee.default)();(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{let o=this.child;await(0,Se.default)(this.child.putMany(async function*(){for await(let a of e){let c=P(a.key);await o.has(c,t)||(yield{key:c,value:a.value}),s.push(a)}}())),s.end()}catch(o){s.end(o)}}),yield*s}has(e,t){return this.child.has(P(e),t)}delete(e,t){return this.child.delete(P(e),t)}deleteMany(e,t){let s=(0,Ee.default)();return(0,Se.default)(this.child.deleteMany(async function*(){for await(let n of e)yield P(n),s.push(n);s.end()}(),t)).catch(n=>{s.end(n)}),s}};return Fr;})();
return BlockstoreDatastoreAdapter}));
